name: Create Versioned Release Branch

on:
  push:
    branches:
      - main

permissions:
  contents: write
  actions: write

jobs:
  create-release-branch:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - run: npm ci

      - name: Dry-run semantic-release to get next version
        id: version
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          DRY_OUTPUT=$(npx semantic-release --dry-run)
          echo "$DRY_OUTPUT"

          # Extract the next version from the dry-run output
          VERSION=$(echo "$DRY_OUTPUT" | grep -Eo 'The next release version is [0-9]+\.[0-9]+\.[0-9]+' | awk '{print $6}')

          if [ -z "$VERSION" ]; then
            echo "Failed to extract version" >&2
            exit 1
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Create/update release branch
        run: |
          RELEASE_BRANCH="release/v${{ steps.version.outputs.version }}"

          if git ls-remote --exit-code --heads origin "$RELEASE_BRANCH"; then
            echo "Branch $RELEASE_BRANCH already exists, skipping creation"
            exit 0
          fi

          git checkout -B "$RELEASE_BRANCH"
          git push origin "$RELEASE_BRANCH"

          echo "Created $RELEASE_BRANCH"
